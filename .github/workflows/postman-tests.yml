name: Newman Tests with NordLayer VPN (Testnet)

on:
  workflow_dispatch:
    inputs:
      override-commit-check:
        description: "Run tests regardless of upstream deployment change"
        required: false
        default: "false"
  schedule:
    - cron: "*/15 * * * *"

jobs:
  run-tests:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      # 1. Checkout the repo so we can read/write the state file.
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      # 2. Read the last processed upstream run ID (if it exists)
      - name: Get Last Processed Upstream Run ID
        id: last-run
        run: |
          if [ -f .last_upstream_run_id.txt ]; then
            cat .last_upstream_run_id.txt
          else
            echo "none"
          fi > last_run_id.txt
          LAST_RUN=$(cat last_run_id.txt)
          echo "Last processed upstream run id: $LAST_RUN"
          echo "LAST_RUN_ID=$LAST_RUN" >> $GITHUB_ENV

      # 3. Query the upstream repo for its latest testnet deployment run.
      - name: Get Latest Upstream Run ID
        id: get-run
        uses: actions/github-script@v6
        with:
          script: |
            const owner = "dydxprotocol";
            const repo = "v4-chain";
            const workflowFile = "indexer-build-and-push-testnet.yml"; // adjust if needed
            const { data: runs } = await github.rest.actions.listWorkflowRuns({
              owner,
              repo,
              workflow_id: workflowFile,
              status: "completed",
              per_page: 1
            });
            if (runs.total_count > 0) {
              const latestRun = runs.workflow_runs[0];
              core.setOutput("run_id", latestRun.id.toString());
              console.log("Latest upstream run id: " + latestRun.id.toString());
            } else {
              core.setOutput("run_id", "none");
              console.log("No upstream workflow run found.");
            }
      # 4. Compare the latest upstream run ID to the stored one.
      - name: Determine if tests should run
        id: check-tests
        run: |
          LAST_RUN_ID="${LAST_RUN_ID:-none}"
          NEW_RUN_ID="${{ steps.get-run.outputs.run_id }}"
          echo "Last processed upstream run id: $LAST_RUN_ID"
          echo "Latest upstream run id: $NEW_RUN_ID"
          OVERRIDE="${{ github.event.inputs.override-commit-check }}"
          if [ "$OVERRIDE" = "true" ]; then
            echo "Override provided, will run tests."
            echo "skip=false" >> $GITHUB_OUTPUT
          else
            if [ "$LAST_RUN_ID" = "$NEW_RUN_ID" ]; then
              echo "Upstream run id has not changed. Skipping tests."
              echo "skip=true" >> $GITHUB_OUTPUT
            else
              echo "New upstream run id detected. Will run tests."
              echo "skip=false" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Show skip flag (for debugging)
        run: echo "skip = ${{ steps.check-tests.outputs.skip }}"

      # 5. Run Newman tests (only if upstream is new or overridden)
      - name: Run Newman Tests for Testnet
        if: steps.check-tests.outputs.skip == 'false'
        run: |
          npm install -g newman newman-reporter-htmlextra
          # Install & configure NordLayer
          sudo apt-get update
          sudo dpkg -i ./nordlayer/nordlayer-latest_1.0.0_all.deb
          sudo apt-get install -f -y
          sudo apt-get update
          sudo apt-get install -y nordlayer
          sudo systemctl daemon-reload
          sudo systemctl restart nordlayer.service
          sleep 2
          sudo chown -R runner:runner /run/nordlayer/
          sudo chmod 755 /run/nordlayer
          sudo chmod 666 /run/nordlayer/nordlayer.sock

          nordlayer login --email "${{ secrets.NORDLAYER_EMAIL }}" --password "${{ secrets.NORDLAYER_PASSWORD }}" --organization "dydxopsdao"
          nordlayer gateways
          nordlayer connect "dos-server-BQG2cKQV"
          echo "Verifying VPN IP..."
          curl ifconfig.me

          newman run postman/collection.json \
            -e postman/environment.testnet.json \
            --reporters cli,htmlextra,junit \
            --reporter-htmlextra-export newman-report.html \
            --reporter-junit-export results.xml

          nordlayer status || true
          nordlayer disconnect || echo "Already disconnected"

      - name: Log when tests are skipped
        if: steps.check-tests.outputs.skip == 'true'
        run: echo "Tests were skipped because the upstream deployment has not changed."

      # 6. If tests ran, update the stored upstream run ID.
      - name: Update Last Processed Upstream Run ID
        if: steps.check-tests.outputs.skip == 'false'
        run: |
          echo "${{ steps.get-run.outputs.run_id }}" > .last_upstream_run_id.txt
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add .last_upstream_run_id.txt
          git commit -m "[skip ci] Update last processed upstream run id to ${{ steps.get-run.outputs.run_id }}"
          git push

      # 7. Upload test artifacts (only if tests ran)
      - name: Upload Test Results (JUnit XML)
        if: steps.check-tests.outputs.skip == 'false'
        uses: actions/upload-artifact@v4
        with:
          name: postman-test-results
          path: results.xml

      - name: Upload HTML Report (Nice UI)
        if: steps.check-tests.outputs.skip == 'false'
        uses: actions/upload-artifact@v4
        with:
          name: postman-html-report
          path: newman-report.html

      # 8. Notify Slack Channel only if tests ran.
      - name: Notify Slack Channel
        if: steps.check-tests.outputs.skip == 'false'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          JOB_STATUS: ${{ job.status }}
        run: |
          if [ "$JOB_STATUS" = "success" ]; then
            COLOR="good"
          else
            COLOR="danger"
          fi
          TEXT="Newman tests on testnet have completed with status: $JOB_STATUS."
          PAYLOAD=$(jq -n \
            --arg channel "indexer-api-testing" \
            --arg username "github-actions" \
            --arg icon_emoji ":rocket:" \
            --arg color "$COLOR" \
            --arg title "Newman Test Run Result" \
            --arg text "$TEXT" \
            '{channel: $channel, username: $username, icon_emoji: $icon_emoji, attachments: [{color: $color, title: $title, text: $text}]}')
          echo "Sending payload to Slack:"
          echo "$PAYLOAD"
          curl -X POST -H "Content-type: application/json" --data "$PAYLOAD" "$SLACK_WEBHOOK_URL"
